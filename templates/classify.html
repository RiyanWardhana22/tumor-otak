{% extends "layout.html" %} {% block title %}Klasifikasi Citra MRI{% endblock %}
{% block content %}
<div class="row g-4 align-items-start py-5">
  <div class="col-lg-5">
    <div class="glass-card p-4">
      <h4 class="fw-semibold mb-3 text-center">Upload Citra MRI</h4>
      <form id="upload-form">
        <div class="mb-3">
          <label for="image-file" class="form-label"
            >Pilih file gambar (.jpg, .png)</label
          >
          <input
            type="file"
            id="image-file"
            class="form-control"
            accept=".jpg,.jpeg,.png"
            required
          />
        </div>
        <div class="d-grid">
          <button type="submit" id="classify-btn" class="btn-glass">
            Klasifikasikan
          </button>
        </div>
      </form>
      <div id="error-box" class="alert alert-danger mt-4 d-none"></div>
    </div>
  </div>

  <div class="col-lg-7">
    <div class="glass-card p-4">
      <h4 class="fw-semibold text-center mb-4">Hasil Klasifikasi</h4>
      <div id="result-container" class="text-center d-none">
        <img
          id="preview-image"
          src="#"
          class="img-fluid rounded mb-3"
          style="max-height: 250px"
        />
        <div id="result-box" class="alert alert-info">
          <h5 id="result-text" class="mb-1 fs-4"></h5>
          <p id="confidence-text" class="mb-0"></p>
        </div>
        <canvas id="probability-chart" class="mt-3"></canvas>
        <div
          id="interpretation-box"
          class="alert alert-secondary mt-3 text-start"
        >
          <strong>Interpretasi:</strong>
          <p id="interpretation-text" class="mb-0"></p>
        </div>
      </div>
      <div
        id="placeholder-text"
        class="text-muted text-center"
        style="
          min-height: 300px;
          display: flex;
          align-items: center;
          justify-content: center;
        "
      >
        <p>Hasil prediksi akan muncul setelah Anda mengunggah gambar.</p>
      </div>
    </div>
  </div>
</div>

{% endblock %} {% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
  const uploadForm = document.getElementById("upload-form");
  const imageFile = document.getElementById("image-file");
  const previewImage = document.getElementById("preview-image");
  const classifyBtn = document.getElementById("classify-btn");

  // Elemen Hasil
  const resultContainer = document.getElementById("result-container");
  const placeholderText = document.getElementById("placeholder-text");
  const resultBox = document.getElementById("result-box");
  const resultText = document.getElementById("result-text");
  const confidenceText = document.getElementById("confidence-text");
  const errorBox = document.getElementById("error-box");

  // Elemen Interpretasi
  const interpretationBox = document.getElementById("interpretation-box");
  const interpretationText = document.getElementById("interpretation-text");

  // Elemen Grafik
  const chartCanvas = document.getElementById("probability-chart");
  let probabilityChart = null;

  imageFile.addEventListener("change", function (event) {
    const file = event.target.files[0];
    if (file) {
      const validTypes = ["image/jpeg", "image/png", "image/jpg"];
      if (!validTypes.includes(file.type)) {
        showError(
          "Format file tidak valid. Harap gunakan .jpg, .png, atau .jpeg"
        );
        imageFile.value = "";
        return;
      }

      const maxSize = 5 * 1024 * 1024;
      if (file.size > maxSize) {
        showError("Ukuran file terlalu besar. Maksimal 5MB.");
        imageFile.value = "";
        return;
      }

      const reader = new FileReader();
      reader.onload = function (e) {
        previewImage.src = e.target.result;
      };
      reader.readAsDataURL(file);

      resultContainer.classList.add("d-none");
      placeholderText.classList.remove("d-none");
      errorBox.classList.add("d-none");
    }
  });

  uploadForm.addEventListener("submit", async function (event) {
    event.preventDefault();
    const file = imageFile.files[0];
    if (!file) {
      showError("Tolong pilih file gambar terlebih dahulu.");
      return;
    }

    const formData = new FormData();
    formData.append("image", file);

    setLoading(true);

    try {
      const response = await fetch("/predict", {
        method: "POST",
        body: formData,
      });

      if (response.ok) {
        const data = await response.json();
        showResult(data);
      } else {
        const errorData = await response.json();
        showError(errorData.error || "Terjadi error yang tidak diketahui.");
      }
    } catch (error) {
      console.error("Error:", error);
      showError("Tidak dapat terhubung ke server. Pastikan server berjalan.");
    } finally {
      setLoading(false);
    }
  });

  function showResult(data) {
    resultText.textContent = data.predicted_class;
    confidenceText.textContent = "Probabilitas: " + data.confidence;
    showInterpretation(data.predicted_class);

    resultContainer.classList.remove("d-none");
    placeholderText.classList.add("d-none");
    errorBox.classList.add("d-none");

    updateChart(data.class_names, data.probabilities);
  }

  function showInterpretation(className) {
    let text = "";
    if (className === "No Tumor") {
      text =
        "Hasil menunjukkan tidak ada tanda-tanda tumor yang terdeteksi pada gambar MRI. Ini adalah hasil normal.";
      resultBox.classList.remove("alert-danger", "alert-warning");
      resultBox.classList.add("alert-success");
    } else if (className === "Pituitary Tumor") {
      text =
        "Terdeteksi adanya tumor Pituari. Tumor ini umumnya jinak dan tumbuh lambat di kelenjar pituitari.";
      resultBox.classList.remove("alert-success", "alert-danger");
      resultBox.classList.add("alert-warning");
    } else {
      text = `Terdeteksi adanya ${className}. Ini adalah jenis tumor yang memerlukan perhatian medis lebih lanjut untuk diagnosis dan penanganan.`;
      resultBox.classList.remove("alert-success", "alert-warning");
      resultBox.classList.add("alert-danger");
    }
    interpretationText.textContent = text;
  }

  function updateChart(labels, data) {
    if (probabilityChart) {
      probabilityChart.destroy();
    }

    probabilityChart = new Chart(chartCanvas, {
      type: "bar",
      data: {
        labels: labels,
        datasets: [
          {
            label: "Probabilitas (%)",
            data: data,
            backgroundColor: [
              "rgba(255, 99, 132, 0.6)",
              "rgba(54, 162, 235, 0.6)",
              "rgba(75, 192, 192, 0.6)",
              "rgba(255, 206, 86, 0.6)",
            ],
            borderColor: [
              "rgba(255, 99, 132, 1)",
              "rgba(54, 162, 235, 1)",
              "rgba(75, 192, 192, 1)",
              "rgba(255, 206, 86, 1)",
            ],
            borderWidth: 1,
          },
        ],
      },
      options: {
        indexAxis: "y",
        scales: {
          x: {
            beginAtZero: true,
            max: 100,
          },
        },
        plugins: {
          legend: {
            display: false,
          },
        },
      },
    });
  }

  function showError(message) {
    errorBox.textContent = message;
    errorBox.classList.remove("d-none");
    resultContainer.classList.add("d-none");
    placeholderText.classList.remove("d-none");
  }

  function setLoading(isLoading) {
    if (isLoading) {
      classifyBtn.disabled = true;
      classifyBtn.innerHTML = `
                <span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>
                Memproses...
            `;
    } else {
      classifyBtn.disabled = false;
      classifyBtn.innerHTML = "Klasifikasikan";
    }
  }
</script>
{% endblock %}
